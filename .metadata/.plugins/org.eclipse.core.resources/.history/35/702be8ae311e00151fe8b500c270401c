import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.logging.Logger;

import org.apache.commons.io.FileUtils;
import org.apache.commons.io.FilenameUtils;
import org.apache.commons.lang3.StringUtils;

public class DfmReaderWriter {
    static final String TAG_OBJECT_START = "object";
    static final String TAG_OBJECT_END   = "end";

    static Logger       log              = Logger.getLogger(DfmReaderWriter.class.getName());
    DfmObject           rootObject;
    DfmObject           currentObject;
    String              currentTag;
    ParsingState        state            = ParsingState.WAITING_OBJECT;

    enum ParsingState {
        UNKNOWN, WAITING_OBJECT, READING_OBJECT, READING_MULTILINE_DATA, READING_MULTILINE_STRING
    };

    public DfmObject read(File dfmFile) throws InterruptedException, IOException, DfmParserException {
        File txtFile = dfmToTxt(dfmFile);
        try (BufferedReader br = new BufferedReader(new FileReader(txtFile.getAbsoluteFile()))) {

            String line;
            state = ParsingState.WAITING_OBJECT;

            while ((line = br.readLine()) != null) {
                parseLine(line);
            }
        }

        return rootObject;
    }

    ArrayList<String> parseTokens(String line, String delimitersRegex, int maxTokens) {
        String[] tokens = line.split(delimitersRegex, maxTokens);
        ArrayList<String> prunedTokens = new ArrayList<String>();
        for (String token : tokens) {
            token = token.trim();
            if (!token.isEmpty())
                prunedTokens.add(token);
        }

        return prunedTokens;
    }

    void parseObjectStart(String line) throws DfmParserException {
        ArrayList<String> tokens = parseTokens(line.trim(), "[ \\:]", 3);

        if (tokens.size() == 0)
            return;

        currentTag = tokens.get(0);
        if (currentTag.compareToIgnoreCase(TAG_OBJECT_START) != 0) {
            throw new DfmParserException("La ligne ne commençait pas par 'object'  : " + line);
        }

        if (tokens.size() < 3) {
            throw new DfmParserException("La ligne est incorrectement formatée  : " + line);
        }

        DfmObject parentObject = currentObject;
        currentObject = new DfmObject();
        if (rootObject == null) {
            rootObject = currentObject;
        }
        if (parentObject != null) {
            parentObject.addChild(currentObject);
        }

        currentObject.setName(tokens.get(1));
        currentObject.setTypeName(tokens.get(2));
        state = ParsingState.READING_OBJECT;
    }

    void parseObjectProperty(String line) throws DfmParserException {
        ArrayList<String> tokens = parseTokens(line, "[=\\:]", 2);
        if (tokens.size() == 0) {
            return;
        }

        currentTag = tokens.get(0);
        if (currentTag.startsWith(TAG_OBJECT_START + " ")) {
            parseObjectStart(line);
        } else if (currentTag.compareToIgnoreCase(TAG_OBJECT_END) == 0) {
            currentObject = currentObject.getParent();
            state = ParsingState.READING_OBJECT;
        } else if (tokens.size() == 2) {
            String value = tokens.get(1);
            if (value.startsWith("{")) {
                state = ParsingState.READING_MULTILINE_DATA;
            } else if (value.startsWith("(")) {
                state = ParsingState.READING_MULTILINE_STRING;
            }

            currentObject.getProperties().put(currentTag, value);
        } else {
            throw new DfmParserException("Incapable de traiter la ligne : " + line);
        }
    }

    void parseMultilineProperty(String line, String endOfPropertyDelim) {
        line = currentObject.getProperties().get(currentTag) + line.trim();
        currentObject.getProperties().put(currentTag, line);
        if (line.endsWith(endOfPropertyDelim))
            state = ParsingState.READING_OBJECT;
    }

    void parseLine(String line) throws DfmParserException {
        switch (state) {
        case WAITING_OBJECT:
        parseObjectStart(line);
            break;
        case READING_OBJECT:
        parseObjectProperty(line);
            break;
        case READING_MULTILINE_STRING:
        parseMultilineProperty(line, ")");
            break;
        case READING_MULTILINE_DATA:
        parseMultilineProperty(line, "}");
            break;
        default:
        throw new DfmParserException("Etat inconnu : " + state.toString());
        }
    }

    private File dfmToTxt(File dfmFile) throws InterruptedException, IOException {
        File txtFile = new File(FilenameUtils.removeExtension(dfmFile.getAbsolutePath()) + ".txt");
        FileUtils.deleteQuietly(txtFile);
        Process process = new ProcessBuilder("C:\\Borland\\CBuilder4\\Bin\\convert.exe", dfmFile.getAbsolutePath()).start();
        process.waitFor();
        return txtFile;
    }

    private File txtToDfm(File txtFile) throws InterruptedException, IOException {
        File dfmFile = new File(FilenameUtils.removeExtension(txtFile.getAbsolutePath()) + ".dfm");
        FileUtils.deleteQuietly(txtFile);
        Process process = new ProcessBuilder("C:\\Borland\\CBuilder4\\Bin\\convert.exe", dfmFile.getAbsolutePath()).start();
        process.waitFor();
        return dfmFile;
    }

    private void write(FileWriter writer, DfmObject rootObject, int indentLevel) throws IOException {
        String indent = StringUtils.repeat(" ", indentLevel);
        writer.write(indent + TAG_OBJECT_START + " " + rootObject.getName() + " : " + rootObject.getTypeName() );
        for (String propertyName : rootObject.getProperties().keySet()) {
            
        }
    }
    
    public void write(File dfmFile, DfmObject rootObject) throws InterruptedException, IOException {
        File txtFile = new File(FilenameUtils.removeExtension(dfmFile.getAbsolutePath()) + ".txt");
        try (FileWriter writer = new FileWriter(txtFile.getAbsoluteFile())) {            
            write(writer, rootObject, 0);
        }
        
        txtToDfm(txtFile);
    }

    
}
